# CircleCI configuration file for automated dependency updates via Renovate.
#
# Scheduled pipelines:
# The `update-dependencies` workflow requires a schedule trigger configured in
# CircleCI UI.
# Go to Project Settings > Triggers > Add Scheduled Trigger:
#   - Trigger name: update-dependencies
#   - Config source: update-dependencies.yml
#   - Branch: develop
#   - Schedule: Every day at 11:05 and 23:05 UTC (or a custom schedule)
# See https://www.vortextemplate.com/docs/continuous-integration/circleci
version: '2.1'

################################################################################
# PARAMETERS
################################################################################

parameters:
  run_update_dependencies:
    type: boolean
    default: false

################################################################################
# JOBS
################################################################################

jobs:
  # Self-hosted dependency updates.
  # Add the following environment variables to the CircleCI project:
  # - RENOVATE_TOKEN: GitHub access token.
  # - RENOVATE_REPOSITORIES: Repository to run Renovate on as `vendor/repository`.
  # - RENOVATE_GIT_AUTHOR: Author for Renovate commits as `Name <email@example.com>`.
  # Variables provided below can be overridden in the CircleCI project settings.
  update-dependencies:
    docker:
      - image: renovate/renovate:40.36.8
        environment:
          RENOVATE_PLATFORM: 'github'
          RENOVATE_AUTODISCOVER: false
          RENOVATE_DEPENDENCY_DASHBOARD_TITLE: 'Renovate Dependency Dashboard (self-hosted) by CircleCI'
          RENOVATE_DEPENDENCY_DASHBOARD: false
          RENOVATE_DRY_RUN: false
          LOG_LEVEL: 'debug'

    steps:
      - checkout
      - run:
          name: Check if RENOVATE_TOKEN is set
          command: |
            if [ -z "${RENOVATE_TOKEN}" ]; then
              echo "RENOVATE_TOKEN is not set. Skipping job."
              circleci-agent step halt
            fi

            if [ -z "${RENOVATE_REPOSITORIES}" ]; then
              echo "Renovate repository is not set. Skipping job."
              circleci-agent step halt
            fi

            if [ -z "${RENOVATE_GIT_AUTHOR}" ]; then
              echo "Renovate git author is not set. Skipping job."
              circleci-agent step halt
            fi

      - run:
          name: Validate Renovate configuration
          command: renovate-config-validator

      - run:
          name: Run Renovate
          command: renovate

################################################################################
# WORKFLOWS
################################################################################

workflows:
  # Self-hosted Renovate workflow.
  # Requires an "update-dependencies" schedule trigger configured in CircleCI UI.
  update-dependencies:
    when:
      and:
        - equal: [scheduled_pipeline, << pipeline.trigger_source >>]
        - equal: ["update-dependencies", << pipeline.schedule.name >>]
    jobs:
      - update-dependencies

  update-dependencies-manual:
    when: << pipeline.parameters.run_update_dependencies >>
    jobs:
      - update-dependencies
