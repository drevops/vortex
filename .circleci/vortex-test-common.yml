# Auto-generated by .vortex/tests/generate-vortex-dev-circleci
# Source: .circleci/build-test-deploy.yml
# Do not edit directly.
version: '2.1'

aliases:
  #;< !PROVISION_TYPE_PROFILE
  # SSH key fingerprint to download the database.
  # Replace this key fingerprint with your own and remove this comment.
  - &db_ssh_fingerprint "SHA256:6d+U5QubT0eAWz+4N2wt+WM2qx6o4cvyvQ6xILETJ84"
  #;> !PROVISION_TYPE_PROFILE

  # SSH key fingerprint to deploy code.
  # Replace this key fingerprint with your own and remove this comment.
  - &deploy_ssh_fingerprint "SHA256:6d+U5QubT0eAWz+4N2wt+WM2qx6o4cvyvQ6xILETJ84"

  # Shared runner container configuration applied to each job.
  - &runner_config
    working_directory: &working_directory ~/project
    environment:
      #;< !PROVISION_TYPE_PROFILE
      VORTEX_DOWNLOAD_DB_SSH_FINGERPRINT: *db_ssh_fingerprint
      #;> !PROVISION_TYPE_PROFILE
      VORTEX_DEPLOY_SSH_FINGERPRINT: *deploy_ssh_fingerprint
    docker:
      # Using the 'runner' container where each job will be executed.
      # This container has all the necessary tools to run a dockerized environment.
      # https://github.com/drevops/ci-runner
      # https://hub.docker.com/repository/docker/drevops/ci-runner/tags
      - image: drevops/ci-runner:26.2.0@sha256:fe1561c2984a1023e84eebe6461056b0b55afedbb2512e6c2c7f19aca6beb398
        auth:
          username: ${VORTEX_CONTAINER_REGISTRY_USER}
          password: ${VORTEX_CONTAINER_REGISTRY_PASS}
        environment:
          # Set runner timezone via UI to ensure that executed operations use correct timestamps.
          # https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
          TZ: UTC
          # Set runner terminal capabilities.
          TERM: xterm-256color
          # Disable strict host key checking for SSH connections.
          VORTEX_SSH_DISABLE_STRICT_HOST_KEY_CHECKING: "1"
          # Remove all SSH keys from the runner container.
          VORTEX_SSH_REMOVE_ALL_KEYS: "1"
          #;< !PROVISION_TYPE_PROFILE
          # How often to refresh the cache of the DB dump. Refer to `date` command.
          VORTEX_CI_DB_CACHE_TIMESTAMP: +%Y%m%d
          # Use previous database caches on this branch as a fallback if the above cache
          # does not match (for example, the cache is available only from the previous
          # day). If "no" is set, the cache will be rebuilt from scratch.
          VORTEX_CI_DB_CACHE_FALLBACK: "yes"
          # Which branch to use as a source of DB caches.
          VORTEX_CI_DB_CACHE_BRANCH: "develop"
          #;> !PROVISION_TYPE_PROFILE
          # Directory to store test results.
          VORTEX_CI_TEST_RESULTS: &test_results /tmp/tests
          # Directory to store test artifacts.
          VORTEX_CI_ARTIFACTS: &artifacts /tmp/artifacts
          # Directory to use for artifact deployments.
          VORTEX_DEPLOY_ARTIFACT_SRC: /tmp/workspace/code
          # Source code location for artifact deployments.
          VORTEX_DEPLOY_ARTIFACT_ROOT: *working_directory
          # Report file location for artifact deployments.
          VORTEX_DEPLOY_ARTIFACT_LOG: /tmp/artifacts/deployment_log.txt
          # Check only minimal stack requirements.
          VORTEX_DOCTOR_CHECK_MINIMAL: 1
    # CI runner resource class.
    # https://circleci.com/docs/2.0/configuration-reference/#resource_class
    # Change to 'large' for faster builds.
    resource_class: medium

  - &step_setup_remote_docker
    setup_remote_docker:
      # Docker Layer Caching allows to significantly speed up builds by caching
      # images built during previous runs.
      # https://circleci.com/docs/2.0/docker-layer-caching/
      docker_layer_caching: false
      version: default

  - &step_process_codebase_for_ci
    run:
      name: Process codebase to run in CI
      command: |
        find . -name "docker-compose.yml" -print0 | xargs -0 -I {} sh -c "sed -i -e ''/###/d'' {} && sed -i -e ''s/##//'' {}"
        mkdir -p /tmp/workspace/code

  - &load_variables_from_dotenv
    run:
      name: Load environment variables from .env file
      # Load variables from .env file, respecting existing values, and make them available for the next steps.
      command: t=$(mktemp) && export -p >"${t}" && set -a && . ./.env && set +a && . "${t}" && export -p >> "$BASH_ENV"

################################################################################
# JOBS
################################################################################

jobs:
  # Base jobs as anchor sources (not referenced in any workflow).
  database: &job-database
    <<: *runner_config
    steps:
      - attach_workspace:
          at: /tmp/workspace

      - add_ssh_keys:
          fingerprints:
            - *db_ssh_fingerprint

      - checkout
      - *step_process_codebase_for_ci
      - *load_variables_from_dotenv
      - *step_setup_remote_docker

      - run:
          name: Create cache keys for database caching as files
          command: |
            echo "${VORTEX_CI_DB_CACHE_BRANCH}" | tee /tmp/db_cache_branch
            echo "${VORTEX_CI_DB_CACHE_FALLBACK/no/${CIRCLE_BUILD_NUM}}" | tee /tmp/db_cache_fallback
            date "${VORTEX_CI_DB_CACHE_TIMESTAMP}" | tee /tmp/db_cache_timestamp
            echo "yes" | tee /tmp/db_cache_fallback_yes

      - restore_cache:
          keys:
            # Restore DB cache based on the cache strategy set by the cache keys below.
            # https://circleci.com/docs/2.0/caching/#restoring-cache
            # Change 'v1' to 'v2', 'v3' etc., commit and push to force cache reset.
            # Lookup cache based on the default branch and a timestamp. Allows
            # to use cache from the very first build on the day (sanitized database dump, for example).
            - v26.2.0-db11-{{ checksum "/tmp/db_cache_branch" }}-{{ checksum "/tmp/db_cache_fallback" }}-{{ checksum "/tmp/db_cache_timestamp" }}
            # Fallback to caching by default branch name only. Allows to use
            # cache from the branch build on the previous day.
            - v26.2.0-db11-{{ checksum "/tmp/db_cache_branch" }}-{{ checksum "/tmp/db_cache_fallback" }}-

      - run:
          name: Download DB
          command: VORTEX_DOWNLOAD_DB_SEMAPHORE=/tmp/download-db-success ./scripts/vortex/download-db.sh
          no_output_timeout: 30m

      #;< MIGRATION
      - run:
          name: Download migration DB
          command: VORTEX_VAR_PREFIX=VORTEX_DOWNLOAD_DB2 ./scripts/vortex/download-db.sh
          no_output_timeout: 30m
      #;> MIGRATION

      # Execute commands after database download script finished: if the
      # DB dump was downloaded - build the site (to ensure that the DB dump
      # is valid) and export the DB using selected method (to support
      # "file-to-image" or "image-to-file" conversions).
      # Note that configuration changes and the DB updates are not applied, so
      # the database will be cached in the same state as downloaded.
      - run:
          name: Export DB after download
          command: |
            [ ! -f /tmp/download-db-success ] && echo "==> Database download semaphore file is missing. DB export will not proceed." && exit 0
            ./scripts/vortex/login-container-registry.sh
            docker compose up --detach && sleep 15
            docker compose exec cli mkdir -p .data && docker compose cp -L .data/db.sql cli:/app/.data/db.sql || true
            docker compose exec $(env | cut -f1 -d= | sed 's/^/-e /') -T cli bash -c "VORTEX_PROVISION_POST_OPERATIONS_SKIP=1 ./scripts/vortex/provision.sh"
            grep -q ^VORTEX_DB_IMAGE .env && rm .data/db.sql || true
            ./scripts/vortex/export-db.sh db.sql
          no_output_timeout: 30m

      - save_cache:
          # Save cache per default branch and the timestamp.
          # The cache will not be saved if it already exists.
          # Note that the cache fallback flag is enabled for this case in order
          # to save cache even if the fallback is not used when restoring it.
          key: v26.2.0-db11-{{ checksum "/tmp/db_cache_branch" }}-{{ checksum "/tmp/db_cache_fallback_yes" }}-{{ checksum "/tmp/db_cache_timestamp" }}
          paths:
            - /root/project/.data

  build: &job_build
    <<: *runner_config
    parallelism: 2
    steps:
      - attach_workspace:
          at: /tmp/workspace

      - checkout
      - *step_process_codebase_for_ci
      - *load_variables_from_dotenv

      - run:
          name: Validate Composer configuration
          command: composer validate --strict || [ "${VORTEX_CI_COMPOSER_VALIDATE_IGNORE_FAILURE:-0}" -eq 1 ]

      #;< !PROVISION_TYPE_PROFILE
      - run:
          name: Set cache keys for database caching
          command: |
            echo "${VORTEX_CI_DB_CACHE_BRANCH}" | tee /tmp/db_cache_branch
            echo "yes" | tee /tmp/db_cache_fallback_yes
            echo "$(date ${VORTEX_CI_DB_CACHE_TIMESTAMP})" | tee /tmp/db_cache_timestamp

      - restore_cache:
          keys:
            # Use cached artifacts from previous builds of this branch.
            # https://circleci.com/docs/2.0/caching/#restoring-cache
            - v26.2.0-db11-{{ checksum "/tmp/db_cache_branch" }}-{{ checksum "/tmp/db_cache_fallback_yes" }}-{{ checksum "/tmp/db_cache_timestamp" }}
            - v26.2.0-db11-{{ checksum "/tmp/db_cache_branch" }}-{{ checksum "/tmp/db_cache_fallback_yes" }}-
      #;> !PROVISION_TYPE_PROFILE

      - *step_setup_remote_docker

      - run:
          name: Login to container registry
          command: ./scripts/vortex/login-container-registry.sh

      - run:
          name: Lint Dockerfiles with Hadolint
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            for file in $(find .docker -name 'Dockerfile' -o -name '*.dockerfile'); do
              echo "Linting ${file}" && cat "${file}" | docker run --rm -i hadolint/hadolint || [ "${VORTEX_CI_HADOLINT_IGNORE_FAILURE:-0}" -eq 1 ]
            done

      - run:
          name: Lint Docker Compose files with DCLint
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker run --rm -v "${PWD}":/app zavoloklom/dclint:3.1.0 . || [ "${VORTEX_CI_DCLINT_IGNORE_FAILURE:-0}" -eq 1 ]

      - run:
          name: Build stack
          command: docker compose up --detach && docker builder prune --all --force

      - run:
          name: Export built codebase
          command: |
            echo "${VORTEX_DEPLOY_TYPES:-}" | grep -vq "artifact" && exit 0 || true
            mkdir -p "/tmp/workspace/code"
            docker compose cp -L cli:"/app/." "/tmp/workspace/code"
            du -sh "/tmp/workspace/code"

      - run:
          name: Install development dependencies
          command: |
            docker compose exec $(env | cut -f1 -d= | sed 's/^/-e /') -T cli bash -c " \
              if [ -n \"${PACKAGE_TOKEN:-}\" ]; then export COMPOSER_AUTH='{\"github-oauth\": {\"github.com\": \"${PACKAGE_TOKEN-}\"}}'; fi && \
              COMPOSER_MEMORY_LIMIT=-1 composer --ansi install --prefer-dist"
            #;< TOOL_ESLINT_STYLELINT
            docker compose exec $(env | cut -f1 -d= | sed 's/^/-e /') -T cli bash -c "yarn install --frozen-lockfile"
            #;> TOOL_ESLINT_STYLELINT

      - run:
          name: Audit Composer packages
          command: docker compose exec -T cli composer audit || [ "${VORTEX_CI_COMPOSER_AUDIT_IGNORE_FAILURE:-0}" -eq 1 ]

      - run:
          name: Validate Composer configuration is normalized
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli composer normalize --dry-run || [ "${VORTEX_CI_COMPOSER_NORMALIZE_IGNORE_FAILURE:-0}" -eq 1 ]

      #;< TOOL_PHPCS
      - run:
          name: Lint code with PHPCS
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/phpcs || [ "${VORTEX_CI_PHPCS_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_PHPCS

      #;< TOOL_PHPSTAN
      - run:
          name: Lint code with PHPStan
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/phpstan || [ "${VORTEX_CI_PHPSTAN_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_PHPSTAN

      #;< TOOL_RECTOR
      - run:
          name: Lint code with Rector
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/rector --dry-run || [ "${VORTEX_CI_RECTOR_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_RECTOR

      #;< TOOL_PHPMD
      - run:
          name: Lint code with PHPMD
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/phpmd . text phpmd.xml || [ "${VORTEX_CI_PHPMD_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_PHPMD

      - run:
          name: Lint code with Twig CS Fixer
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/twig-cs-fixer || [ "${VORTEX_CI_TWIG_CS_FIXER_IGNORE_FAILURE:-0}" -eq 1 ]

      #;< TOOL_BEHAT
      - run:
          name: Lint code with Gherkin Lint
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/gherkinlint lint tests/behat/features || [ "${VORTEX_CI_GHERKIN_LINT_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_BEHAT

      #;< TOOL_ESLINT_STYLELINT
      - run:
          name: Lint module code with NodeJS linters
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli bash -c "yarn run lint" || [ "${VORTEX_CI_NODEJS_LINT_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> TOOL_ESLINT_STYLELINT

      #;< DRUPAL_THEME
      - run:
          name: Lint theme code with NodeJS linters
          command: |
            { [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ]; } || [ "${VORTEX_FRONTEND_BUILD_SKIP:-0}" -eq 1 ] && exit 0
            docker compose exec -T cli bash -c "yarn --cwd=\${WEBROOT}/themes/custom/\${DRUPAL_THEME} run lint" || [ "${VORTEX_CI_NODEJS_LINT_IGNORE_FAILURE:-0}" -eq 1 ]
      #;> DRUPAL_THEME

      - run:
          name: Provision site
          command: |
            if [ -f .data/db.sql ]; then
              docker compose exec cli mkdir -p .data
              docker compose cp -L .data/db.sql cli:/app/.data/db.sql
            fi
            #;< MIGRATION
            if [ -f ".data/${VORTEX_DOWNLOAD_DB2_FILE:-db2.sql}" ]; then
              docker compose exec -T cli mkdir -p .data
              docker compose cp -L ".data/${VORTEX_DOWNLOAD_DB2_FILE:-db2.sql}" cli:"/app/.data/${VORTEX_DOWNLOAD_DB2_FILE:-db2.sql}"
            fi
            #;> MIGRATION
            docker compose exec $(env | cut -f1 -d= | sed 's/^/-e /') -T cli ./scripts/vortex/provision.sh
          no_output_timeout: 30m

      #;< TOOL_PHPUNIT
      - run:
          name: Test with PHPUnit
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            docker compose exec -T cli vendor/bin/phpunit || [ "${VORTEX_CI_PHPUNIT_IGNORE_FAILURE:-0}" -eq 1 ]

      - run:
          name: Process PHPUnit logs and coverage
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            mkdir -p "${VORTEX_CI_ARTIFACTS}"
            if docker compose ps --services --filter "status=running" | grep -q cli && docker compose exec cli test -d /app/.logs; then
               docker compose cp cli:/app/.logs/. "${VORTEX_CI_ARTIFACTS}/"
            fi

      - run:
          name: Check code coverage threshold
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            RATE=$(grep -om1 'line-rate="[0-9.]*"' /tmp/artifacts/coverage/phpunit/cobertura.xml | tr -cd '0-9.')
            PERCENT=$(awk "BEGIN {printf \"%.2f\", $RATE*100}")
            echo "Coverage: $PERCENT% (threshold: ${VORTEX_CI_CODE_COVERAGE_THRESHOLD:-90}%)"
            if [ "${PERCENT//./}" -lt "$((${VORTEX_CI_CODE_COVERAGE_THRESHOLD:-90}*100))" ]; then
              echo "FAIL: coverage too low"
              exit 1
            fi

      - run:
          name: Post coverage summary as PR comment
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            [ "${VORTEX_CI_CODE_COVERAGE_PR_COMMENT_SKIP:-0}" = "1" ] && exit 0
            [ -z "${CIRCLE_PULL_REQUEST}" ] && exit 0
            [ -z "${GITHUB_TOKEN}" ] && exit 0
            COVERAGE_CONTENT=$(sed '/./,$!d' /tmp/artifacts/coverage/phpunit/coverage.txt)
            PR_NUMBER=$(echo "${CIRCLE_PULL_REQUEST}" | cut -d'/' -f 7)
            REPO_SLUG="${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
            curl -s -X POST \
              -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO_SLUG}/issues/${PR_NUMBER}/comments" \
              -d "$(jq -n --arg body "\`\`\`
            ${COVERAGE_CONTENT}
            \`\`\`" '{body: $body}')"

      - run:
          name: Upload code coverage reports to Codecov
          command: |
            [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ] && [ "${CIRCLE_NODE_INDEX:-0}" -ne 0 ] && exit 0
            if [ -n "${CODECOV_TOKEN}" ] && [ -d /tmp/artifacts/coverage ] && ! echo "${CIRCLE_BRANCH}" | grep -q '^deps/'; then
              codecov -Z -s /tmp/artifacts/coverage;
            fi
      #;> TOOL_PHPUNIT

      #;< TOOL_BEHAT
      - run:
          name: Test with Behat
          command: |
            if [ "${CIRCLE_NODE_TOTAL:-1}" -gt 1 ]; then export VORTEX_CI_BEHAT_PROFILE="${VORTEX_CI_BEHAT_PROFILE:-p${CIRCLE_NODE_INDEX}}"; fi
            echo "Running with ${VORTEX_CI_BEHAT_PROFILE:-default} profile"
            docker compose exec -T cli php -d memory_limit=-1 vendor/bin/behat --colors --strict --profile="${VORTEX_CI_BEHAT_PROFILE:-default}" || \
              docker compose exec -T cli php -d memory_limit=-1 vendor/bin/behat --colors --strict --rerun --profile="${VORTEX_CI_BEHAT_PROFILE:-default}" || \
              [ "${VORTEX_CI_BEHAT_IGNORE_FAILURE:-0}" -eq 1 ]
          no_output_timeout: 30m
      #;> TOOL_BEHAT

      - run:
          name: Process test logs and artifacts
          command: |
            mkdir -p "${VORTEX_CI_TEST_RESULTS}" "${VORTEX_CI_ARTIFACTS}"
            if docker compose ps --services --filter "status=running" | grep -q cli && docker compose exec cli test -d /app/.logs; then
               docker compose cp cli:/app/.logs/. "${VORTEX_CI_ARTIFACTS}/"
              if docker compose exec -T cli sh -c '[ -d /app/.logs/test_results/ ]'; then
                 docker compose cp cli:/app/.logs/test_results/. "${VORTEX_CI_TEST_RESULTS}/"
              fi
            fi
          when: always

      - store_test_results:
          path: *test_results

      - store_artifacts:
          path: *artifacts

      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - code

  # DIDI-FI variant jobs
  vortex-dev-didi-database-fi:
    <<: *job-database
    environment:
      VORTEX_DOWNLOAD_DB_SOURCE: url
      VORTEX_DOWNLOAD_DB_FORCE: 1
      VORTEX_DB_IMAGE: drevops/vortex-dev-mariadb-drupal-data-demo-destination-11.x
      VORTEX_DEPLOY_CONTAINER_REGISTRY_IMAGE_TAG: vortex-dev-didi-database-fi
      VORTEX_EXPORT_DB_CONTAINER_REGISTRY_DEPLOY_PROCEED: 1
      VORTEX_CI_DB_CACHE_BRANCH: vortex-dev-didi-fi

  vortex-dev-didi-build-fi:
    <<: *job_build
    environment:
      VORTEX_DB_IMAGE: drevops/vortex-dev-mariadb-drupal-data-demo-destination-11.x:vortex-dev-didi-database-fi
      VORTEX_CI_DB_CACHE_BRANCH: vortex-dev-didi-fi
      MIGRATION_SKIP: 1

  # DIDI-II variant jobs
  vortex-dev-database-ii:
    <<: *job-database
    environment:
      VORTEX_DOWNLOAD_DB_SOURCE: VORTEX_CONTAINER_REGISTRY
      VORTEX_DOWNLOAD_DB_FORCE: 1
      VORTEX_DB_IMAGE: drevops/vortex-dev-mariadb-drupal-data-demo-destination-11.x
      VORTEX_DEPLOY_CONTAINER_REGISTRY_IMAGE_TAG: vortex-dev-database-ii
      VORTEX_EXPORT_DB_CONTAINER_REGISTRY_DEPLOY_PROCEED: 1
      VORTEX_CI_DB_CACHE_BRANCH: vortex-dev-didi-ii

  vortex-dev-didi-build-ii:
    <<: *job_build
    environment:
      VORTEX_DB_IMAGE: drevops/vortex-dev-mariadb-drupal-data-demo-destination-11.x:vortex-dev-database-ii
      VORTEX_CI_DB_CACHE_BRANCH: vortex-dev-didi-ii
      MIGRATION_SKIP: 1

################################################################################
# WORKFLOWS
################################################################################

workflows:
  vortex-dev-didi-fi:
    jobs:
      - vortex-dev-didi-database-fi
      - vortex-dev-didi-build-fi:
          requires:
            - vortex-dev-didi-database-fi

  vortex-dev-didi-ii:
    jobs:
      - vortex-dev-database-ii
      - vortex-dev-didi-build-ii:
          requires:
            - vortex-dev-database-ii
