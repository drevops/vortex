# Authoring tests

**Vortex** uses [Bats](https://github.com/bats-core/bats-core) for testing.
Bats is a TAP-compliant testing framework for Bash. It provides a simple way to
verify that the UNIX programs you write behave as expected.

See [Bats documentation](https://bats-core.readthedocs.io/) for more information.

## Installation

```bash
npm install --prefix .vortex/tests
```

## Usage

```bash
# Run a single test.
bats .vortex/tests/bats/helpers.bats

# Some tests require Composer and container registry tokens.
TEST_GITHUB_TOKEN=<yourtoken> TEST_VORTEX_CONTAINER_REGISTRY_USER=<youruser> TEST_VORTEX_CONTAINER_REGISTRY_PASS=<yourpass> bats .vortex/tests/bats/workflow.smoke.bats

# To preserve test run directory.
bats --no-tempdir-cleanup .vortex/tests/bats/helpers.bats

# To override Bats temporary directory where tests are ran (required for container tests).
mkdir -p $HOME/.bats-tmp # run once
TMPDIR=$HOME/.bats-tmp bats .vortex/tests/bats/helpers.bats

# Run all tests, preserving the temporary directory.
TEST_GITHUB_TOKEN=<yourtoken> \
TEST_VORTEX_CONTAINER_REGISTRY_USER=<youruser> \
TEST_VORTEX_CONTAINER_REGISTRY_PASS=<yourpass> \
TMPDIR=$HOME/.bats-tmp \
bats --no-tempdir-cleanup .vortex/tests/bats/*.bats
```

## Updating test assets

Some tests use test fixtures such as Drupal database snapshots.

### Updating demo database file dump

1. Run fresh build of **Vortex** locally:
```bash
echo "DRUPAL_PROFILE=standard">>.env.local
echo "VORTEX_PROVISION_USE_PROFILE=1">>.env.local
rm .data/db.sql
AHOY_CONFIRM_RESPONSE=1 ahoy build
```
2. Add a new `Basic page` node with title `Welcome to the demo site!` and content
```
Welcome to the demo site!

This example page is sourced from the Vortex example database dump file to demonstrate database importing capabilities.
```
3. Truncate `cache_*` and `watchdog` tables.
4. Export DB `ahoy export-db` and rename it to `db.sql`.
5. Run `ahoy provision` and check if there are no errors or warnings in the output.
6. Run `ahoy test` and check if all tests pass.
7. Rename `db.sql` to `db_dX.demo.sql`, where `X` is the next Drupal version number.
5. Update references in code from the current version `db_dY.demo.sql` to `db_dX.demo.sql`.
6. Upload the DB dump file to the latest release as an asset (`db_dX.demo.sql`).

### Updating demo database container image

:::note "Work in progress"

    The documentation section is still a work in progress.

:::
