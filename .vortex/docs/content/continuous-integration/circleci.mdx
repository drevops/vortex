---
sidebar_position: 2
---

# CircleCI

[CircleCI](https://circleci.com/) is a cloud-based continuous integration and
delivery platform that automates the build, test, and deployment process.

For general CircleCI documentation, refer to the
[CircleCI Documentation](https://circleci.com/docs/).

:::info

For information about the CI workflow structure, jobs, and caching strategy,
see the [CI overview](/docs/continuous-integration).

:::

## Onboarding

Before you begin, ensure you have:

- A CircleCI account connected to your repository
- Repository admin access to configure project settings
- API credentials for your hosting provider (if deploying)

### 1. Enable the project

[Log in to CircleCI](https://app.circleci.com/) and add your repository as a new
project. CircleCI will connect to your GitHub account, detect the configuration
files in the [`.circleci/`](https://github.com/drevops/vortex/blob/main/.circleci/)
directory, and start running builds automatically when you push code.

### 2. Add SSH key for database download

To download a database from your hosting provider during CI builds, you need an
SSH key that has access to your hosting environments.

1. Generate an SSH key pair:

   ```shell
   ssh-keygen -m PEM -t rsa -b 4096 -C "deployer+myproject-circleci@example.com" -f ~/.ssh/deployer_myproject_circleci -N ""
   ```

    :::tip Key naming convention

    Use the `+<project>-<service>` suffix in the email comment (e.g.,
    `deployer+myproject-circleci@example.com`) to identify what the key is used for.
    This helps when managing multiple deployment keys across different projects and
    services.

    :::

2. Add the contents of the public key (e.g., `~/.ssh/<key>.pub`) to your hosting
   provider's authorized keys for read access.
3. Add the private key in CircleCI under **Project Settings → SSH Keys**.
   CircleCI will generate a fingerprint - copy it for the next step.

### 3. Add SSH key for deployment

To deploy code to your hosting provider, you need an SSH key with write access
to your hosting environments.

:::note

The database source and deployment destination may be different providers (e.g.,
downloading a database from Acquia but deploying to Lagoon). If they are the
same provider, you can use a single key for both operations.

:::

1. Generate an SSH key pair (skip if using the same key as above):

   ```shell
   ssh-keygen -m PEM -t rsa -b 4096 -C "deployer+myproject-circleci@example.com" -f ~/.ssh/deploy_myproject_circleci -N ""
   ```

2. Add the public key to your hosting provider
3. Add the private key in CircleCI under **Project Settings → SSH Keys**.
   Copy the fingerprint for the next step.

### 4. Update SSH fingerprints in config

CircleCI uses SSH key fingerprints to load the correct keys into the runner
container. Update the YAML anchors in your
[`.circleci/build-test-deploy.yml`](https://github.com/drevops/vortex/blob/main/.circleci/build-test-deploy.yml)
file:

- `db_ssh_fingerprint` - your database download SSH key fingerprint
- `deploy_ssh_fingerprint` - your deployment SSH key fingerprint

### 5. Configure environment variables

Add the following variables in **Project Settings → Environment Variables**:

**Acquia:**

| Variable               | Description             |
|------------------------|-------------------------|
| `VORTEX_ACQUIA_KEY`    | Acquia Cloud API key    |
| `VORTEX_ACQUIA_SECRET` | Acquia Cloud API secret |

### 6. Configure schedule triggers

Some workflows run on a schedule rather than on every push. These schedules must
be configured in the CircleCI UI.

Go to **Project Settings → Triggers** and create the following scheduled
triggers:

#### Nightly database

Caches a fresh database dump overnight so that builds the next day start faster.

| Setting       | Value                       |
|---------------|-----------------------------|
| Trigger name  | `nightly-db`                |
| Config source | `build-test-deploy.yml`     |
| Branch        | `develop`                   |
| Schedule      | Every day at 18:00 UTC      |

#### Update dependencies (optional)

Runs [Renovate](https://docs.renovatebot.com/) to automatically update
project dependencies. Only needed if you use the self-hosted Renovate
workflow provided in
[`.circleci/update-dependencies.yml`](https://github.com/drevops/vortex/blob/main/.circleci/update-dependencies.yml).

| Setting       | Value                              |
|---------------|------------------------------------|
| Trigger name  | `update-dependencies`              |
| Config source | `update-dependencies.yml`          |
| Branch        | `develop`                          |
| Schedule      | Every day at 11:05 and 23:05 UTC   |

:::note

The trigger names (`nightly-db`, `update-dependencies`) must match exactly -
they are referenced in the workflow `when` conditions in the configuration files.

:::

## Maintenance

### Update deployment branches

The `deploy` job only runs for specific branch patterns. To modify which branches
trigger deployments, update the `only` filter regex in the `deploy` job under
the `workflows` section of `.circleci/build-test-deploy.yml`:

```yaml
filters:
  branches:
    only: /^(production|main|master|develop)$|^project\/[a-zA-z0-9\-\.]+|^(feature|bugfix)\/[a-zA-Z0-9\-\.\,_]+$|^ci.*|^(release|hotfix)\/[0-9]+(\.[0-9]+){2}(-rc\.[0-9]+)?$|^(release|hotfix)\/[0-9]{4}-[0-9]{2}-[0-9]{2}(\.[0-9]+)?$/
```

### Update nightly database schedule

The nightly database job caches a fresh database dump for faster builds the next
day. To change the schedule, update the trigger in the CircleCI UI under
**Project Settings → Triggers → nightly-db**.

See [Configure schedule triggers](#6-configure-schedule-triggers) for the
recommended default values.

### Change runner resource class

For faster builds, you can upgrade the
[runner resource class](https://circleci.com/docs/resource-class-overview/) in
the `runner_config` section. Note that this may affect your CircleCI billing:

```yaml
resource_class: large  # Options: small, medium, large, xlarge
```

### Change test parallelism

To speed up test execution, you can increase the number of parallel runners in
the `build` job. See [Running tests in parallel](https://circleci.com/docs/parallelism-faster-jobs/)
for more information:

```yaml
build:
  parallelism: 4  # Run tests across 4 containers
```

When adding more containers, distribute Behat scenarios across them using
profile tags (`@p0`, `@p1`, `@p2`, etc.) in your feature files. Since the first
container also runs linting, PHPUnit, and coverage, assign more Behat scenarios
to the additional containers to keep build times balanced.

See [Test parallelism](/docs/continuous-integration#test-parallelism) for details
on how tests are distributed across containers.

### SSH access for debugging

CircleCI provides built-in SSH access to debug failing builds. Click the
**Rerun job with SSH** button on a failed job to get SSH connection details.
See [Debugging with SSH](https://circleci.com/docs/ssh-access-jobs/) for more
information.

### Adjust build timeout

If builds are timing out, increase the `no_output_timeout` value for
long-running steps:

```yaml
- run:
    name: Long running task
    command: ./scripts/long-task.sh
    no_output_timeout: 60m  # Default is 10m
```

### Code coverage threshold

The workflow enforces a minimum code coverage threshold. If coverage falls below
the threshold, the build fails.

Configure the threshold by setting the `VORTEX_CI_CODE_COVERAGE_THRESHOLD`
environment variable in **Project Settings → Environment Variables**. Default
is `90` (percent).

Coverage reports can be posted as PR comments. This requires a `GITHUB_TOKEN`
environment variable with permission to post comments. To disable PR comments,
set `VORTEX_CI_CODE_COVERAGE_PR_COMMENT_SKIP` to `1`.
