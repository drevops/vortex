#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to GitHub.
 *
 * Provides dispatching "deployments" notifications to GitHub.
 * @see https://docs.github.com/en/rest/deployments/deployments
 *
 * GitHub deployments can only be created if all checks pass. Thus, the
 * deployment notification dispatch will fail if CI hasn't completed and
 * reported successful checks.
 */

declare(strict_types=1);

namespace DrevOps\VortexTooling;

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// -----------------------------------------------------------------------------

// GitHub notification deployment label (branch name, PR number, or custom).
$notify_label = getenv_required('VORTEX_NOTIFY_GITHUB_LABEL', 'VORTEX_NOTIFY_LABEL');

// GitHub notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$notify_event = getenv_required('VORTEX_NOTIFY_GITHUB_EVENT', 'VORTEX_NOTIFY_EVENT');

// GitHub notification personal access token.
$github_token = getenv_required('VORTEX_NOTIFY_GITHUB_TOKEN', 'GITHUB_TOKEN');

// GitHub notification repository in owner/repo format.
$github_repository = getenv_required('VORTEX_NOTIFY_GITHUB_REPOSITORY');

// GitHub notification environment type: production, uat, dev, pr.
// Used as the 'environment' parameter in GitHub's Deployment API.
$github_env_type = getenv_default('VORTEX_NOTIFY_GITHUB_ENVIRONMENT_TYPE', 'PR');

// -----------------------------------------------------------------------------

info('Started GitHub notification for %s event.', $notify_event);

/**
 * Validate deployment ID.
 *
 * @param mixed $deployment_id
 *   Deployment ID to validate.
 *
 * @return bool
 *   TRUE if valid, FALSE otherwise.
 */
function deployment_id_is_valid(mixed $deployment_id): bool {
  if (empty($deployment_id)) {
    return FALSE;
  }

  $id_str = (string) $deployment_id;
  $length = strlen($id_str);

  // Check length (9-11 digits) and numeric format.
  return $length >= 9 && $length <= 11 && ctype_digit($id_str);
}

if ($notify_event === 'pre_deployment') {
  note('GitHub pre-deployment notification summary:');
  note('Repository      : ' . $github_repository);
  note('Label (ref)     : ' . $notify_label);
  note('Environment Type: ' . $github_env_type);
  note('Event           : ' . $notify_event);

  task('Creating deployment');

  $payload_data = [
    'ref' => $notify_label,
    'environment' => $github_env_type,
    'auto_merge' => FALSE,
    'required_contexts' => [],
  ];

  $url = sprintf('https://api.github.com/repos/%s/deployments', $github_repository);
  $response = request_post($url, json_encode($payload_data), [
    'Authorization: token ' . $github_token,
    'Accept: application/vnd.github.v3+json',
  ]);

  $deployment_id = NULL;
  if ($response['ok'] && $response['body']) {
    $payload = json_decode((string) $response['body'], TRUE);
    $deployment_id = $payload['id'] ?? NULL;
  }

  // Check deployment ID.
  if (!deployment_id_is_valid($deployment_id)) {
    fail('Failed to get a deployment ID for a %s event. Payload: %s. Wait for GitHub checks to finish and try again.', $notify_event, $response['body'] ?: 'empty');
  }

  pass('Created deployment with ID %s.', $deployment_id);
}
else {
  $env_url = getenv_required('VORTEX_NOTIFY_GITHUB_ENVIRONMENT_URL', 'VORTEX_NOTIFY_ENVIRONMENT_URL');

  task('Finding latest deployment for ref %s', $notify_label);

  $url = sprintf('https://api.github.com/repos/%s/deployments?ref=%s', $github_repository, urlencode($notify_label));
  $response = request_get($url, [
    'Authorization: token ' . $github_token,
    'Accept: application/vnd.github.v3+json',
  ]);

  // Get first (latest) deployment ID.
  $deployment_id = NULL;
  if ($response['ok'] && $response['body']) {
    $payload = json_decode((string) $response['body'], TRUE);
    if (is_array($payload) && !empty($payload)) {
      $first = reset($payload);
      $deployment_id = $first['id'] ?? NULL;
    }
  }

  // Check deployment ID.
  if (!deployment_id_is_valid($deployment_id)) {
    fail('Failed to find a previous deployment for ref %s. Payload: %s', $notify_label, $response['body'] ?: 'empty');
  }

  pass('Found deployment with ID %s.', $deployment_id);

  note('GitHub post-deployment notification summary:');
  note('Repository         : ' . $github_repository);
  note('Label (ref)        : ' . $notify_label);
  note('Environment Type   : ' . $github_env_type);
  note('Environment URL    : ' . $env_url);
  note('Deployment ID      : ' . $deployment_id);
  note('Event              : ' . $notify_event);

  task('Marking deployment as finished');

  $status_data = [
    'state' => 'success',
    'environment_url' => $env_url,
  ];

  $url = sprintf('https://api.github.com/repos/%s/deployments/%s/statuses', $github_repository, $deployment_id);
  $response = request_post($url, json_encode($status_data), [
    'Accept: application/vnd.github.v3+json',
    'Authorization: token ' . $github_token,
  ]);

  $status = NULL;
  if ($response['ok'] && $response['body']) {
    $payload = json_decode((string) $response['body'], TRUE);
    $status = $payload['state'] ?? NULL;
  }

  if ($status !== 'success') {
    fail('Previous deployment was found, but was unable to update the deployment status. Payload: %s', $response['body'] ?: 'empty');
  }

  pass('Marked deployment as finished.');
}

info('Finished GitHub notification for %s event.', $notify_event);
