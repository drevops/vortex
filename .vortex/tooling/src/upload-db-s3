#!/usr/bin/env php
<?php

/**
 * @file
 * Upload DB dump to S3.
 *
 * Uses AWS Signature Version 4 with curl (no AWS CLI required).
 *
 * IMPORTANT! This script runs outside the container on the host system.
 */

declare(strict_types=1);

namespace DrevOps\VortexTooling;

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// -----------------------------------------------------------------------------

// AWS access key.
$access_key = getenv_required('VORTEX_UPLOAD_DB_S3_ACCESS_KEY', 'S3_ACCESS_KEY');

// AWS secret key.
$secret_key = getenv_required('VORTEX_UPLOAD_DB_S3_SECRET_KEY', 'S3_SECRET_KEY');

// S3 bucket name.
$bucket = getenv_required('VORTEX_UPLOAD_DB_S3_BUCKET', 'S3_BUCKET');

// S3 region.
$region = getenv_required('VORTEX_UPLOAD_DB_S3_REGION', 'S3_REGION');

// S3 prefix (path within the bucket).
$prefix = getenv_default('VORTEX_UPLOAD_DB_S3_PREFIX', 'S3_PREFIX', '');

// Directory with database dump file.
$db_dir = getenv_default('VORTEX_UPLOAD_DB_S3_DB_DIR', 'VORTEX_DB_DIR', './.data');

// Database dump file name.
$db_file = getenv_default('VORTEX_UPLOAD_DB_S3_DB_FILE', 'VORTEX_DB_FILE', 'db.sql');

// Remote database dump file name.
$remote_file = getenv_default('VORTEX_UPLOAD_DB_S3_REMOTE_FILE', 'db.sql');

// S3 storage class.
$storage_class = getenv_default('VORTEX_UPLOAD_DB_S3_STORAGE_CLASS', 'STANDARD');

// -----------------------------------------------------------------------------

$local_file = $db_dir . '/' . $db_file;
if (!file_exists($local_file)) {
  fail(sprintf('Database dump file %s does not exist.', $local_file));
}

info('Started database dump upload to S3.');

// Ensure prefix ends with a trailing slash if non-empty.
if ($prefix !== '') {
  $prefix = rtrim($prefix, '/') . '/';
}

// AWS SigV4 helpers (inlined).
/**
 * HMAC-SHA256 with either a raw key or hex key.
 */
function upload_hmac_sha256(string $key, string $data, bool $hex_key = FALSE): string {
  if ($hex_key) {
    $key = hex2bin($key);
  }
  return hash_hmac('sha256', $data, $key);
}

/**
 * Create AWS SigV4 signature for upload.
 */
function upload_create_aws_signature(
  string $secret_key,
  string $date_short,
  string $region,
  string $service,
  string $string_to_sign,
): string {
  $date_key = upload_hmac_sha256('AWS4' . $secret_key, $date_short);
  $region_key = upload_hmac_sha256($date_key, $region, TRUE);
  $service_key = upload_hmac_sha256($region_key, $service, TRUE);
  $signing_key = upload_hmac_sha256($service_key, 'aws4_request', TRUE);

  return upload_hmac_sha256($signing_key, $string_to_sign, TRUE);
}

$request_type = 'PUT';
$auth_type = 'AWS4-HMAC-SHA256';
$service = 's3';
$base_url = sprintf('.%s.%s.amazonaws.com', $service, $region);
$date_short = gmdate('Ymd');
$date_long = gmdate('Ymd\THis\Z');
$object_url = sprintf('https://%s%s/%s%s', $bucket, $base_url, $prefix, $remote_file);

note(sprintf('Local file:     %s', $local_file));
note(sprintf('Remote file:    %s%s', $prefix, $remote_file));
note(sprintf('S3 bucket:      %s', $bucket));
note(sprintf('S3 region:      %s', $region));
if ($prefix !== '') {
  note(sprintf('S3 prefix:      %s', $prefix));
}
note(sprintf('Storage class:  %s', $storage_class));

$content_type = 'application/octet-stream';

$payload_hash = hash_file('sha256', $local_file);

$header_list = 'content-type;host;x-amz-content-sha256;x-amz-date;x-amz-server-side-encryption;x-amz-storage-class';

$canonical_request = sprintf(
  "%s\n/%s%s\n\ncontent-type:%s\nhost:%s%s\nx-amz-content-sha256:%s\nx-amz-date:%s\nx-amz-server-side-encryption:AES256\nx-amz-storage-class:%s\n\n%s\n%s",
  $request_type,
  $prefix, $remote_file,
  $content_type,
  $bucket, $base_url,
  $payload_hash,
  $date_long,
  $storage_class,
  $header_list,
  $payload_hash
);

$canonical_request_hash = hash('sha256', $canonical_request);

$string_to_sign = sprintf(
  "%s\n%s\n%s/%s/%s/aws4_request\n%s",
  $auth_type,
  $date_long,
  $date_short,
  $region,
  $service,
  $canonical_request_hash
);

$signature = upload_create_aws_signature($secret_key, $date_short, $region, $service, $string_to_sign);

$auth_header = sprintf(
  '%s Credential=%s/%s/%s/%s/aws4_request, SignedHeaders=%s, Signature=%s',
  $auth_type,
  $access_key,
  $date_short,
  $region,
  $service,
  $header_list,
  $signature
);

$response = request($object_url, ['method' => 'PUT', 'headers' => ['Content-Type: ' . $content_type, 'Host: ' . $bucket . $base_url, 'X-Amz-Content-SHA256: ' . $payload_hash, 'X-Amz-Date: ' . $date_long, 'X-Amz-Server-Side-Encryption: AES256', 'X-Amz-Storage-Class: ' . $storage_class, 'Authorization: ' . $auth_header], 'upload_file' => $local_file, 'timeout' => 600]);
if (!$response['ok']) {
  fail('Failed to upload database dump to S3.');
}

pass('Finished database dump upload to S3.');
