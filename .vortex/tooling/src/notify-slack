#!/usr/bin/env php
<?php

/**
 * @file
 * Notification dispatch to Slack.
 *
 * Sends deployment notifications to Slack channels using Incoming Webhooks.
 */

declare(strict_types=1);

namespace DrevOps\VortexTooling;

require_once __DIR__ . '/helpers.php';
execute_override(basename(__FILE__));

// -----------------------------------------------------------------------------

// Slack notification project name.
$notify_project = getenv_required('VORTEX_NOTIFY_SLACK_PROJECT', 'VORTEX_NOTIFY_PROJECT');

// Slack notification deployment label (branch name, PR number, or custom).
$notify_label = getenv_required('VORTEX_NOTIFY_SLACK_LABEL', 'VORTEX_NOTIFY_LABEL');

// Slack notification environment URL.
$notify_env_url = getenv_required('VORTEX_NOTIFY_SLACK_ENVIRONMENT_URL', 'VORTEX_NOTIFY_ENVIRONMENT_URL');

// Slack notification login URL.
$notify_login_url = getenv_default('VORTEX_NOTIFY_SLACK_LOGIN_URL', 'VORTEX_NOTIFY_LOGIN_URL', $notify_env_url . '/user/login');

// Slack notification event type.
//
// Can be 'pre_deployment' or 'post_deployment'.
$notify_event = getenv_default('VORTEX_NOTIFY_SLACK_EVENT', 'VORTEX_NOTIFY_EVENT', 'post_deployment');

// Slack notification message template (for fallback text).
//
// Available tokens:
// - %project% - Project name
// - %label% - Deployment label
// - %timestamp% - Deployment timestamp
// - %environment_url% - Environment URL
// - %login_url% - Login URL.
$slack_message = getenv_default('VORTEX_NOTIFY_SLACK_MESSAGE', "## This is an automated message ##\nSite %project% %label% has been deployed at %timestamp% and is available at %environment_url%.\nLogin at: %login_url%");

// Slack notification webhook URL.
// The incoming Webhook URL from your Slack app configuration.
// @see https://www.vortextemplate.com/docs/workflows/notifications#slack
$slack_webhook = getenv_required('VORTEX_NOTIFY_SLACK_WEBHOOK');

// Slack notification target channel (optional, overrides webhook default).
// Format: #channel-name or @username
$slack_channel = getenv('VORTEX_NOTIFY_SLACK_CHANNEL');

// Slack notification bot display name (optional).
$slack_username = getenv_default('VORTEX_NOTIFY_SLACK_USERNAME', 'Deployment Bot');

// Slack notification bot icon emoji (optional).
$slack_icon = getenv_default('VORTEX_NOTIFY_SLACK_ICON_EMOJI', ':rocket:');

// ------------------------------------------------------------------------------

info('Started Slack notification.');

$timestamp = date('d/m/Y H:i:s T');

$slack_fallback_message = replace_tokens($slack_message, [
  'project' => $notify_project,
  'label' => $notify_label,
  'timestamp' => $timestamp,
  'environment_url' => $notify_env_url,
  'login_url' => $notify_login_url,
]);

// Determine color based on event type.
$color = 'good';
$event_label = 'Deployment Complete';
if ($notify_event === 'pre_deployment') {
  $color = '#808080';
  $event_label = 'Deployment Starting';
}

// Build the message title.
$title = sprintf('%s: %s', $event_label, $notify_project);

// Build fields array - conditionally include Environment and Login for
// post_deployment only.
$fields = [
  ['title' => 'Deployment', 'value' => $notify_label, 'short' => TRUE],
  ['title' => 'Time', 'value' => $timestamp, 'short' => TRUE],
];

// Only include Environment and Login links for post-deployment notifications.
// Pre-deployment notifications should not show these as the site is not yet
// available.
if ($notify_event !== 'pre_deployment') {
  $fields[] = ['title' => 'Environment', 'value' => sprintf('<%s|View Site>', $notify_env_url), 'short' => TRUE];
  $fields[] = ['title' => 'Login', 'value' => sprintf('<%s|Login Here>', $notify_login_url), 'short' => TRUE];
}

// Build payload.
$data = [
  'username' => $slack_username,
  'icon_emoji' => $slack_icon,
  'attachments' => [
    [
      'color' => $color,
      'fallback' => $slack_fallback_message,
      'title' => $title,
      'fields' => $fields,
      'footer' => 'Vortex Deployment',
      'ts' => time(),
    ],
  ],
];

if (!empty($slack_channel)) {
  $data['channel'] = $slack_channel;
}

$payload = json_encode($data, JSON_UNESCAPED_SLASHES);

// Extract webhook domain for display (hide secret path).
$webhook_domain = parse_url($slack_webhook, PHP_URL_SCHEME) . '://' . parse_url($slack_webhook, PHP_URL_HOST);

note('Slack notification summary:');
note('Project        : ' . $notify_project);
note('Deployment     : ' . $notify_label);
note('Environment URL: ' . $notify_env_url);
note('Login URL      : ' . $notify_login_url);
note('Webhook        : %s/***', $webhook_domain);
note('Channel        : ' . ($slack_channel ?: '<default>'));
note('Username       : ' . $slack_username);
note('Event          : ' . $event_label);

task('Sending notification to Slack');

$response = request_post($slack_webhook, $payload, [
  'Content-Type: application/json',
]);

if ($response['status'] !== 200) {
  fail('Unable to send notification to Slack. HTTP status: %s', $response['status']);
}

pass('Slack notification sent successfully.');

info('Finished Slack notification.');
