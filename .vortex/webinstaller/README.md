# Vortex Installer Web Interface

A modern, reactive web interface for the Vortex Drupal project template installer. Built with Alpine.js, esbuild, and Joi validation with comprehensive E2E testing.

## Overview

This web interface provides an intuitive, tab-based form for configuring Vortex Drupal projects. It features real-time validation, auto-generated fields, conditional visibility, responsive design, and a comprehensive testing suite.

## Architecture

### Frontend Stack
- **Alpine.js 3.14.9**: Reactive JavaScript framework loaded via CDN for data binding and DOM manipulation
- **esbuild**: Fast JavaScript bundler for compiling and minifying application code
- **Sass**: CSS preprocessor for modular stylesheets with live compilation
- **live-server**: Development server with automatic browser refresh on file changes
- **Joi**: Client-side form validation library served via CDN
- **Cypress**: End-to-end testing framework

### Code Quality Tools
- **ESLint 9.18.0**: JavaScript linting with industry standard rulesets
- **Stylelint**: SCSS/CSS linting with standard configuration  
- **Prettier**: Code formatting with consistent style guidelines

### Key Features
- **Real-time Validation**: Form fields validate as you type using Joi schemas
- **Auto-generated Fields**: Machine names, repositories, and domains generate automatically
- **Conditional Fields**: Sections show/hide based on user selections with smooth animations
- **Responsive Design**: Adapts to different screen sizes with dynamic CSS scaling
- **Help System**: Contextual help sidebar with detailed field explanations
- **Comprehensive Testing**: Full E2E test coverage with Cypress

## Project Structure

```
web/
├── index.html                 # Main HTML template
├── src/
│   ├── js/
│   │   └── installer.js       # Alpine.js app logic and validation
│   └── scss/
│       ├── styles.scss        # Main stylesheet entry point
│       ├── _variables.scss    # CSS custom properties
│       ├── _base.scss         # Base styles and typography
│       ├── _components.scss   # Component-specific styles
│       ├── _animations.scss   # CSS animations and transitions
│       └── _responsive.scss   # Responsive design rules
├── dist/                      # Built assets (generated by build tools)
│   ├── scripts.js             # Bundled JavaScript (esbuild)
│   └── styles.css             # Compiled CSS (sass)
├── cypress/                   # E2E test suite
│   ├── e2e/
│   │   ├── workflow.cy.js     # Full workflow testing
│   │   └── validation.cy.js   # Form validation testing
│   └── support/
│       └── e2e.js             # Cypress configuration
├── package.json               # Node.js dependencies and build scripts
├── cypress.config.js          # Cypress test configuration
├── eslint.config.js           # ESLint configuration (flat config)
├── .stylelintrc.json          # Stylelint configuration
├── .prettierrc.cjs            # Prettier configuration
├── .prettierignore            # Prettier ignore patterns
└── README.md                  # This documentation
```

## Development

### Prerequisites

- Node.js (version 16 or higher)
- NPM or Yarn

### Setup

```bash
# Install dependencies
npm install

# Start development server
npm run dev

# Build for production
npm run build

# Individual build commands
npm run build:js   # Build JavaScript only
npm run build:scss # Build CSS only

# Code quality and linting
npm run lint       # Check all linting (JS, CSS, formatting)
npm run lint-fix   # Automatically fix all fixable issues

# Run E2E tests
npm run test

# Open interactive test runner
npm run test:open
```

### Development Server

The development environment provides:
- **Live Reload**: Automatic browser refresh on file changes via live-server
- **Watch Mode**: Concurrent watching of JavaScript and SCSS files
- **Fast Compilation**: esbuild for JavaScript, Sass for CSS
- **Local**: http://localhost:3000/
- **Network**: Accessible on local network

### Build Process

The build system processes:
- **JavaScript**: Bundles `src/js/installer.js` → `dist/scripts.js` (esbuild)
- **SCSS**: Compiles `src/scss/styles.scss` → `dist/styles.css` (sass)
- **Development**: Watch mode with live reload
- **Production**: Minified and optimized output

## Form Configuration

### Tab Structure
1. **General Information**: Site name, machine name, organization, domain
2. **Repository**: Git provider, tokens, repository settings
3. **Drupal**: Installation profile, module prefix, theme name
4. **Services**: Optional services (Solr, Valkey, ClamAV)
5. **Hosting**: Hosting provider, web root directory
6. **Workflow**: Site provisioning and database sources
7. **CI/CD**: Continuous integration provider
8. **Deployment**: Deployment method configuration
9. **Dependencies**: Automated dependency updates
10. **Database**: Database connection settings
11. **Advanced**: Debug mode and test settings

### Auto-Generated Fields

The application automatically generates several fields based on user input:

```javascript
// Site Name: "My Awesome Site" generates:
siteMachineName: "my_awesome_site"
modulePrefix: "maas" (first letters of words, max 4 chars)
publicDomain: "my-awesome-site.com"

// Organization + Site generates:
githubRepository: "my_org/my_awesome_site"
databaseContainerImage: "my_org/my_awesome_site-data:latest"
```

### Conditional Field Logic

Fields show/hide based on user selections:

```javascript
// Repository provider affects visible fields
repoProvider === 'github' → GitHub token and repository fields
repoProvider === 'none' → No repository fields

// Hosting provider affects web root
hostingProvider === 'acquia' → webRoot = 'docroot' (disabled)
hostingProvider === 'lagoon' → webRoot = 'web' (disabled)
hostingProvider === 'other' → webRoot = user input (enabled)

// Database source affects container image field
databaseSource === 'container_image' → Shows container image input
```

## Validation System

### Architecture

The validation system uses Joi schemas with real-time feedback:

1. **Field Markup**: Each validated field includes:
   ```html
   <input type="text" 
          id="site-machine-name"
          x-model="siteMachineName"
          @input="validateField('site-machine-name', $event.target.value)"
          @blur="validateField('site-machine-name', $event.target.value)"
          data-validation="required|machine_name">
   <div class="validation-error" id="site-machine-name-error" style="display: none;"></div>
   ```

2. **Validation Function**: Processes rules and applies UI feedback:
   ```javascript
   window.validateField = function(fieldId, value) {
     // Parse validation rules from data-validation attribute
     // Build Joi schema based on rules
     // Validate value and update UI classes/messages
     // Return boolean result (true = valid, false = invalid)
   }
   ```

3. **Schema Building**: Dynamic Joi schema creation:
   ```javascript
   function buildValidationSchema(rulesString) {
     const rules = rulesString.split('|');
     let schema = Joi.string();
     
     rules.forEach(rule => {
       switch (rule) {
         case 'required':
           schema = schema.required();
           break;
         case 'machine_name':
           schema = schema.pattern(/^[a-z0-9_]+$/);
           break;
         // ... other rules
       }
     });
     
     return schema;
   }
   ```

### Validation Rules

#### Machine Name Fields
- **Pattern**: `^[a-z0-9_]+$` (lowercase letters, numbers, underscores only)
- **Error Message**: "No spaces allowed. Use only lowercase letters, numbers, and underscores."
- **Applied to**: Site machine name, organization machine name

#### Required Fields
- **Site Name**: 2-100 characters, required
- **Organization Name**: 2-100 characters, required
- **Site Machine Name**: Auto-generated but can be customized

#### Domain Validation
- **Pattern**: Valid domain format (e.g., example.com, sub.example.com)
- **Error Message**: "Must be a valid domain name (e.g., example.com)"

#### Other Rules
- `min:N` - Minimum character length
- `max:N` - Maximum character length
- `email` - Valid email format
- `url` - Valid URL format

### CSS Validation States

- `.valid`: Green border (`--success-color`)
- `.invalid`: Red border (`--error-color`)
- `.validation-error`: Styled error messages below fields

## Alpine.js Data Structure

The main Alpine.js data object manages all form state:

```javascript
window.installerData = function() {
  return {
    // Form fields
    siteName: '',
    siteMachineName: '',
    orgName: '',
    publicDomain: '',
    repoProvider: 'github',
    hostingProvider: 'acquia',
    // ... other fields
    
    // Helper methods
    updateMachineNames() {
      // Auto-generates machine names from human names
      this.siteMachineName = this.toMachineName(this.siteName);
      this.orgMachineName = this.toMachineName(this.orgName);
      // Triggers validation on updated fields
    },
    
    toMachineName(str) {
      // Converts strings to machine-readable format
      return str.toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '_')
        .replace(/_{2,}/g, '_')
        .replace(/^_|_$/g, '');
    },
    
    isDbSourceAvailable(source) {
      // Filters database sources based on hosting provider
      if (source === 'acquia' && this.hostingProvider === 'lagoon') return false;
      if (source === 'lagoon' && this.hostingProvider === 'acquia') return false;
      return true;
    }
  }
}
```

## Testing

### E2E Test Suite

Cypress tests are organized into two main suites that provide comprehensive coverage:

#### 1. Workflow Tests (`cypress/e2e/workflow.cy.js`)

Tests the complete user journey through the installer:

```javascript
describe('Standard Workflow', () => {
  it('should complete the full installation workflow', () => {
    // Tests navigation through all 11 tabs
    // Verifies auto-generation of machine names, repositories, domains
    // Confirms form state persistence across tab switches
    // Validates conditional field visibility
  })
  
  it('should handle conditional fields correctly', () => {
    // Tests GitHub conditional fields (show/hide)
    // Tests custom Drupal profile conditional field
    // Tests database source conditional fields
    // Tests provision type affecting database source
  })
  
  it('should update auto-generated fields when base values change', () => {
    // Tests site name → machine name generation
    // Tests organization → repository generation
    // Tests module prefix generation (first letters, max 4 chars)
    // Tests container image generation
  })
  
  it('should handle hosting provider changes correctly', () => {
    // Tests Acquia → docroot (disabled)
    // Tests Lagoon → web (disabled)
    // Tests Other → custom input (enabled)
  })
})
```

#### 2. Validation Tests (`cypress/e2e/validation.cy.js`)

Tests form validation functionality comprehensively:

```javascript
describe('Form Validation', () => {
  describe('Machine Name Validation', () => {
    // Tests spaces in machine names (should fail)
    // Tests uppercase letters (should fail)
    // Tests special characters (should fail)
    // Tests valid machine names (should pass)
    // Tests real-time validation as user types
  })
  
  describe('Required Field Validation', () => {
    // Tests empty required fields show errors
    // Tests filled required fields show success
  })
  
  describe('Domain Validation', () => {
    // Tests invalid domain formats
    // Tests valid domains and subdomains
  })
  
  describe('Auto-generated Field Validation', () => {
    // Tests that auto-generated fields are valid
    // Tests validation triggers on auto-generation
  })
  
  describe('Validation System Integrity', () => {
    // Tests Joi library availability
    // Tests validateField function exists
    // Tests multiple field validation independence
  })
})
```

### Running Tests

```bash
# Run all tests headlessly
npx cypress run

# Run specific test file
npx cypress run --spec cypress/e2e/workflow.cy.js
npx cypress run --spec cypress/e2e/validation.cy.js

# Open interactive test runner (GUI)
npx cypress open

# Run tests in specific browser
npx cypress run --browser chrome
```

### Test Patterns

Tests follow consistent patterns for reliability:

```javascript
beforeEach(() => {
  cy.visit('/')
  cy.wait(1000) // Wait for Alpine.js and Joi initialization
})

// Test validation state changes
cy.get('#field-name').clear().type('invalid input')
cy.get('#field-name').should('have.class', 'invalid')
cy.get('#field-name-error').should('be.visible')
cy.get('#field-name-error').should('contain', 'expected error message')

// Test conditional field visibility
cy.get('input[name="radio-group"][value="option"]').check()
cy.get('#conditional-field').should('be.visible')

// Test auto-generation
cy.get('#source-field').clear().type('Source Value')
cy.get('#target-field').should('have.value', 'expected_generated_value')
```

## Help System

The installer uses an inline help content architecture:

### Implementation
Each form field includes a hidden `.field-help-extended` div:

```html
<div class="form-group">
    <label for="site-name">
        Site Name
        <button class="help-icon" onclick="showHelp(this)" type="button">?</button>
    </label>
    <input type="text" id="site-name" />
    <div class="field-help-extended" style="display: none;">
        <h4>Site Name</h4>
        <p>The human-readable name for your Drupal site...</p>
        <ul>
            <li>Examples: "My Company Website", "Blog Platform"</li>
            <li>Can be changed later in Drupal admin</li>
        </ul>
    </div>
</div>
```

### Features
- **Side panel**: Slides in from right with modal overlay
- **Rich content**: HTML formatting, lists, links
- **Keyboard shortcuts**: Escape key to close
- **Contextual**: Content lives next to the field it describes

## Styling System

### CSS Custom Properties

The design system uses CSS custom properties for theming:

```scss
:root {
  --primary-color: #3b82f6;
  --primary-hover: #2563eb;
  --success-color: #10b981;
  --error-color: #ef4444;
  --warning-color: #f59e0b;
  --scale-factor: 1; // Dynamic scaling based on viewport
}
```

### Responsive Design

- **Dynamic Scaling**: CSS `--scale-factor` adjusts based on viewport height (600px-1200px)
- **Scale Range**: 0.7 - 1.0 for optimal readability
- **Breakpoints**: Mobile-first responsive design
- **Layout**: Flexbox-based layout that adapts to screen size

### Component Architecture

Styles are organized by component:
- **Variables**: CSS custom properties and SCSS variables
- **Base**: Typography, reset, global styles
- **Components**: Form elements, tabs, buttons, validation states
- **Animations**: Smooth transitions for conditional fields
- **Responsive**: Mobile, tablet, desktop breakpoints

## Browser Support

- **Modern Browsers**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **JavaScript**: ES2020 features via esbuild transpilation
- **CSS**: CSS Custom Properties, Flexbox, CSS Grid support required
- **Alpine.js**: 3.x compatible environments

## Performance

- **Bundle Size**: ~5.6KB JavaScript (95% reduction from Vite), ~9KB CSS (gzipped)
- **Load Time**: <1s on modern connections
- **Build Speed**: esbuild provides near-instant compilation (~2ms)
- **Validation**: Real-time with minimal performance impact (~1ms per validation)
- **Memory Usage**: Alpine.js reactive system is lightweight
- **Animations**: Hardware-accelerated CSS transitions

## Security Considerations

- **Client-side Only**: All validation is client-side; server validation required for production
- **No Sensitive Data**: Form doesn't handle passwords or secrets directly
- **XSS Protection**: Alpine.js provides automatic escaping
- **CDN Assets**: Alpine.js and Joi loaded from trusted CDNs for better caching

## Troubleshooting

### Common Issues

1. **Validation not working**:
   - Check Joi library: `window.joi` should exist (lowercase)
   - Verify `data-validation` attributes are present
   - Ensure Alpine.js initializes before validation attempts

2. **Auto-generation not updating**:
   - Check `updateMachineNames()` calls on input events
   - Verify Alpine.js reactive bindings with `x-model`
   - Check for JavaScript errors in console

3. **Conditional fields not showing**:
   - Verify Alpine.js `x-show` directives syntax
   - Check data model values match expected conditions
   - Inspect element classes for transition states

4. **Build issues**:
   - Clear `dist/` directory: `rm -rf dist/`
   - Check SCSS syntax errors in console
   - Run individual build commands: `npm run build:js` or `npm run build:scss`

5. **Test failures**:
   - Ensure server is running on correct port (3000)
   - Check for timing issues (increase wait times)
   - Verify element selectors are correct

### Code Quality Issues

1. **Linting errors**:
   - Run `npm run lint` to check all code quality issues
   - Run `npm run lint-fix` to automatically fix fixable issues
   - Check specific tools: `npm run lint:js`, `npm run lint:css`, `npm run lint:format`

2. **Code formatting**:
   - Prettier handles all formatting automatically
   - Files are formatted on `npm run lint-fix`
   - Check `.prettierrc.cjs` for formatting rules

### Debugging

1. **Browser Console**: Check for JavaScript errors and validation logs
2. **Alpine.js DevTools**: Install browser extension for reactive data inspection
3. **Network Tab**: Verify all assets load correctly (CDN scripts, scripts.js, styles.css)
4. **Cypress Tests**: Run tests to verify functionality systematically
5. **Validation Debug**: Call `window.validateField('field-id', 'test-value')` manually

### Debug Commands

```javascript
// Test validation function directly
window.validateField('site-machine-name', 'test with spaces') // Should return false

// Check Joi availability
console.log('Joi:', window.joi || window.Joi)

// Check Alpine.js data
console.log('Alpine data:', Alpine.data)

// Test field element
document.getElementById('site-machine-name').getAttribute('data-validation')
```

## Deployment

### Production Build

```bash
# Build optimized assets
npm run build

# Preview production build locally
npm run preview
```

### Static Deployment

The installer can be deployed as static files:
1. Run `npm run build`
2. Deploy `index.html` and `dist/` directories
3. Ensure web server serves `index.html` for all routes
4. Configure appropriate cache headers for assets

### CDN Deployment

For CDN deployment:
- Assets in `dist/` can be served from CDN
- Update asset paths in `index.html` if needed
- Alpine.js and Joi are already loaded from CDN

---

This documentation provides complete coverage of the Vortex Installer web interface architecture, implementation, testing, and deployment. The system is designed to be maintainable, testable, and user-friendly with comprehensive validation and help systems.